name: Cross-Platform Build

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -sSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 libxcb-xinerama0-dev \
          libxcb1 libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
          libxcb-shape0 libxcb-randr0 libxcb-xfixes0 \
          libxcb-sync1 libxcb-xkb1 libxkbcommon-x11-0

    - name: Install Python dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pyinstaller

    - name: Verify Qt installation
      run: |
        python -c "from PyQt5.QtCore import QT_VERSION_STR; print(f'Qt version: {QT_VERSION_STR}')"
        python -c "import PyQt5; print('PyQt5 path:', PyQt5.__file__)"

    - name: Build Linux executable
      run: |
        python build_cross_platform.py --platform linux

    - name: Upload Linux build
      uses: actions/upload-artifact@v4
      with:
        name: metavinci-linux
        path: build/dist/linux/metavinci
        retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        architecture: 'x64'

    - name: Install uv
      run: |
        irm https://astral.sh/uv/install.ps1 | iex
        $env:Path = "$env:USERPROFILE\.cargo\bin;" + $env:Path
        echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH

    - name: Install Python dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pyinstaller

    - name: Verify installation
      run: |
        python -c "import PyQt5; print('PyQt5 installed successfully')"
        python -c "import sys; print('Python path:', sys.executable)"

    - name: Build Windows executable
      run: |
        python build_cross_platform.py --platform windows

    - name: Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: metavinci-windows
        path: build/dist/windows/metavinci.exe
        retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -sSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install Python dependencies
      run: |
        # Install PyQt5 with specific version constraints
        uv pip install "PyQt5>=5.15.0,<5.16.0" "PyQt5-Qt5>=5.15.0,<5.16.0" "PyQt5-sip>=12.15.0,<13.0.0"
        uv pip install -r requirements.txt
        uv pip install pyinstaller

    - name: Verify Qt installation
      run: |
        python -c "from PyQt5.QtWidgets import QApplication; app = QApplication([]); print('Qt application started successfully')"
        python -c "import PyQt5; print(f'PyQt5 version: {PyQt5.QtCore.PYQT_VERSION_STR}')"

    - name: Build macOS executable
      run: |
        python build_cross_platform.py --platform macos

    - name: Upload macOS build
      uses: actions/upload-artifact@v4
      with:
        name: metavinci-macos
        path: build/dist/mac/metavinci
        retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all builds
      uses: actions/download-artifact@v4
      with:
        path: dist

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/metavinci-linux/metavinci
          dist/metavinci-windows/metavinci.exe
          dist/metavinci-macos/metavinci
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Cross-Platform Release

          ### Downloads
          - **Linux**: `metavinci` (x86_64)
          - **Windows**: `metavinci.exe` (x86_64)
          - **macOS**: `metavinci` (Universal)

          ### Installation
          ```bash
          # Linux/macOS
          chmod +x metavinci
          ./metavinci

          # Windows
          # Double-click metavinci.exe or run from command prompt
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}